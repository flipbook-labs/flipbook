local process = require("@lune/process")
local rbxasset = require("@lunepkg/rbxasset")

local parseArgs = require("./lib/parseArgs")
local run = require("./lib/run")

local args = parseArgs(process.args)

local channel = if args.channel then args.channel else "dev"
assert(channel == "dev" or channel == "prod", `bad value for channel (must be one of "dev" or "prod", got "{channel}")`)

local apiKey = assert(args.apiKey, "--apiKey must be supplied with a valid Open Cloud API key")
assert(typeof(apiKey) == "string", `bad value for apiKey (string expected, got {typeof(apiKey)})`)

run("lune", { "run", "build", "--channel", channel, "--output", "Flipbook.rbxm" })

-- Each of the assets defined in rbxasset.toml map to one of the options of
-- `--channel` for simplicity
rbxasset.publishPackageAsync(process.cwd, channel, apiKey)
